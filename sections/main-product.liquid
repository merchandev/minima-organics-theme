{%- liquid
  assign first_3d_model = product.media | where: 'media_type', 'model' | first
-%}

<product-info
  id="MainProduct-{{ section.id }}"
  class="section-{{ section.id }}-padding"
  data-section="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-update-url="true"
  data-url="{{ product.url }}"
>
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
  {{ 'component-accordion.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'component-slider.css' | asset_url | stylesheet_tag }}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }

    /* Side-by-Side Flex Layout (Robust) */
    .flourist-container {
      display: flex;
      flex-wrap: wrap;
      gap: 50px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .flourist-media-col {
      flex: 1 1 500px;
      min-width: 300px;
    }

    .flourist-info-col {
      flex: 1 1 400px;
      min-width: 300px;
      position: sticky;
      top: 40px;
      height: fit-content;
      padding: 20px;
    }

    /* Vertical Gallery Styles - 1:1 RESTRAINT */
    .flourist-gallery-layout {
      display: flex;
      gap: 20px;
    }
    .flourist-thumbs {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 80px;
      flex-shrink: 0;
    }
    .flourist-thumb-item {
      width: 100%;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      border-radius: 4px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .flourist-thumb-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      opacity: 0.6;
    }
    .flourist-thumb-item:has(img.is-active), .flourist-thumb-item:hover {
      border-color: #1A2E1A;
    }
    .flourist-thumb-item:hover img, .flourist-thumb-item img.is-active {
      opacity: 1;
    }
    
    .flourist-main-img {
      flex-grow: 1;
    }
    .flourist-main-img img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }

    /* Typography & UI Elements */
    .method-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    .method-badge {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: 1px solid #EAEAEA;
      padding: 6px 14px;
      border-radius: 30px;
      color: #1A2E1A;
    }
    .stars-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 15px;
      color: #1A2E1A;
      font-size: 14px;
    }
    .stars-row span {
      opacity: 0.5;
      font-size: 12px;
    }

    .flourist-title h1 {
      font-family: 'Cormorant Garamond', serif !important;
      font-size: 38px !important;
      font-weight: 300 !important;
      color: #1A2E1A !important;
      margin: 0 0 10px 0 !important;
      line-height: 1.1 !important;
    }
    .flourist-subtitle {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.6;
      margin-bottom: 30px;
      display: block;
    }

    /* Variant Selectors */
    .variant-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0 30px;
    }
    .v-box {
      border: 1px solid #E5E5E5;
      padding: 12px 28px;
      cursor: pointer;
      font-size: 12px;
      text-transform: uppercase;
      transition: 0.3s;
    }
    .v-box.active {
      background: #1A2E1A;
      color: #FFF;
      border-color: #1A2E1A;
    }

    /* Quantity Selector */
    .flourist-qty-wrap {
      margin-bottom: 15px;
    }
    .flourist-qty-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
      display: block;
    }
    .flourist-qty {
      display: flex;
      align-items: center;
      border: 1px solid #E5E5E5;
      width: fit-content;
      border-radius: 4px;
    }
    .flourist-qty button {
      background: transparent;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      color: #1A2E1A;
    }
    .flourist-qty input {
      width: 40px;
      border: none;
      text-align: center;
      font-size: 14px;
      -moz-appearance: textfield;
    }
    .flourist-qty input::-webkit-outer-spin-button,
    .flourist-qty input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* High-Impact CTA */
    .flourist-cta {
      background: #1A2E1A !important;
      color: #FFF !important;
      width: 100%;
      padding: 22px !important;
      border: none !important;
      text-transform: uppercase !important;
      letter-spacing: 0.1em !important;
      font-weight: 500 !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      border-radius: 4px !important;
      cursor: pointer !important;
    }

    /* Information Tabs */
    .flourist-tabs {
       display: flex;
       gap: 35px;
       margin-top: 50px;
       border-bottom: 1px solid #F0F0F0;
    }
    .flourist-tab {
      padding-bottom: 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      opacity: 0.4;
      border-bottom: 2px solid transparent;
    }
    .flourist-tab.active {
      opacity: 1;
      border-color: #1A2E1A;
    }

    @media screen and (max-width: 749px) {
      .flourist-thumbs { display: none; }
      .flourist-gallery-layout { display: block; }
    }
  {%- endstyle -%}

  <div class="flourist-container">
    <div class="flourist-media-col">
      <div class="flourist-gallery-layout">
        {%- if product.media.size > 1 -%}
          <div class="flourist-thumbs small-hide">
            {%- for media in product.media -%}
              <div class="flourist-thumb-item">
                <img src="{{ media.preview_image | image_url: width: 150 }}"
                     data-src="{{ media.preview_image | image_url: width: 1200 }}"
                     class="{% if forloop.first %}is-active{% endif %}"
                     alt="{{ media.alt | escape }}"
                     data-thumb-index="{{ forloop.index0 }}">
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}
        <div class="flourist-main-img">
          <img src="{{ product.featured_media | image_url: width: 1200 }}" alt="{{ product.title | escape }}">
        </div>
      </div>
    </div>

    <div class="flourist-info-col">
      <div class="method-badges">
        <span class="method-badge">Recogida en tienda</span>
        <span class="method-badge">Entrega local</span>
        <span class="method-badge">Envío</span>
      </div>
      <div class="stars-row">★★★★★ <span>111 reseñas</span></div>

      <div class="flourist-title"><h1>{{ product.title }}</h1></div>
      <div class="flourist-price-wrap" style="margin-bottom: 20px;">
        {% render 'price', product: product, use_variant: true, price_class: 'price--large' %}
      </div>
      
      {%- form 'product', product, id: 'product-form', class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
        
        {%- unless product.variants.size == 1 and product.variants.first.title == 'Default Title' -%}
        <div class="flourist-variants">
          <label class="flourist-qty-label">Talla: {{ product.selected_or_first_available_variant.title }}</label>
          <div class="variant-boxes">
            {%- for variant in product.variants -%}
              <div class="v-box {% if variant == product.selected_or_first_available_variant %}active{% endif %}" data-variant-id="{{ variant.id }}">
                {{ variant.title }}
              </div>
            {%- endfor -%}
          </div>
        </div>
        {%- endunless -%}

        <div class="flourist-qty-wrap">
          <label class="flourist-qty-label" for="Quantity-{{ section.id }}">Cantidad</label>
          <div class="flourist-qty">
            <button type="button" onclick="this.parentNode.querySelector('input').stepDown()">-</button>
            <input type="number" name="quantity" id="Quantity-{{ section.id }}" value="1" min="1">
            <button type="button" onclick="this.parentNode.querySelector('input').stepUp()">+</button>
          </div>
        </div>

        <button type="submit" name="add" class="flourist-cta">
          <span>Añadir al carro</span>
          <span>• {{ product.selected_or_first_available_variant.price | money }}</span>
        </button>
      {%- endform -%}

      <div class="flourist-tabs">
        <div class="flourist-tab active">Descripción</div>
        <div class="flourist-tab">Ingredientes</div>
        <div class="flourist-tab">Detalles</div>
      </div>
      <div class="rte" style="margin-top: 30px; font-size: 14px; line-height: 1.7;">
        {{ product.description }}
      </div>
    </div>
  </div>
</product-info>

<script>
  // Thumbnail gallery switcher
  (function() {
    var thumbImgs = document.querySelectorAll('.flourist-thumb-item img');
    var mainImg   = document.querySelector('.flourist-main-img img');
    thumbImgs.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        if (!mainImg || !this.dataset.src) return;
        mainImg.src = this.dataset.src;
        thumbImgs.forEach(function(t) { t.classList.remove('is-active'); });
        this.classList.add('is-active');
      });
    });
  })();

  // Variant switching
  document.querySelectorAll('.v-box').forEach(function(box) {
    box.addEventListener('click', function() {
      var variantId = this.dataset.variantId;
      document.querySelector('input[name="id"]').value = variantId;
      document.querySelectorAll('.v-box').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
    });
  });
</script>

{% schema %}
{
  "name": "Product Pages",
  "settings": [
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding Top", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding Bottom", "default": 36 }
  ],
  "blocks": [
    { "type": "@app" },
    { "type": "text", "name": "Text" },
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { "type": "variant_picker", "name": "Variant Picker", "limit": 1 },
    { "type": "buy_buttons", "name": "Buy Buttons", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 },
    { "type": "collapsible_tab", "name": "Collapsible Tab" }
  ]
}
{% endschema %}
