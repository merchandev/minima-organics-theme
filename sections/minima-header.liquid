{%- style -%}
  .minima-header-wrap { position: relative; z-index: 100; font-family: 'Inter', sans-serif; }
  .minima-announcement { background: #1A2E1A; color: #F8F5F0; text-align: center; padding: 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; }
  .minima-header { background: #F8F5F0; border-bottom: 1px solid rgba(26,46,26,0.1); padding: 16px 0; }
  .minima-header__inner { display: flex; justify-content: space-between; align-items: center; max-width: 1260px; margin: 0 auto; padding: 0 32px; }
  .minima-header__logo-link { display: block; line-height: 0; }
  .minima-header__logo-img { height: 45px; width: auto; display: block; }
  .minima-header__nav { display: flex; gap: 32px; list-style: none; margin: 0; padding: 0; }
  .minima-header__nav a { font-size: 13px; font-weight: 500; text-transform: uppercase; text-decoration: none; color: #1A2E1A; opacity: 0.8; transition: opacity 0.2s; }
  .minima-header__nav a:hover { opacity: 1; border-bottom: 1px solid #1A2E1A; }
  .minima-header__center { display: flex; align-items: center; gap: 24px; }
  .minima-header__actions { display: flex; gap: 20px; align-items: center; }
  .minima-header__cart {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    text-decoration: none;
    color: #1A2E1A;
    border: 1px solid #1A2E1A;
    padding: 8px 16px;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
  }
  .minima-header__cart svg { width: 18px; height: 18px; }
  .cart-count-bubble {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #1A2E1A;
    color: #F8F5F0;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
  }

  .mh-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #1A2E1A;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .mh-action-btn svg { width: 22px; height: 22px; }
  .mh-action-btn--search { display: none; }
  .minima-header__menu-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #1A2E1A;
  }
  .minima-header__menu-toggle svg { width: 24px; height: 24px; }

  /* CUSTOM MINI CART DRAWER */
  .minima-cart-drawer {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100%;
    background: #F8F5F0;
    z-index: 1001;
    box-shadow: -5px 0 30px rgba(0,0,0,0.1);
    transition: right 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    display: flex;
    flex-direction: column;
    color: #1A2E1A;
  }
  .minima-cart-drawer.is-active { right: 0; }
  .minima-cart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
  }
  .minima-cart-overlay.is-active { opacity: 1; visibility: visible; }
  
  .drawer-header { padding: 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(26,46,26,0.05); }
  .drawer-title { font-family: 'Cormorant Garamond', serif; font-size: 2.8rem; font-weight: 500; margin: 0; }
  .drawer-close { cursor: pointer; padding: 10px; opacity: 0.6; transition: 0.2s; }
  .drawer-close:hover { opacity: 1; }
  
  .drawer-items { flex: 1; overflow-y: auto; padding: 40px; }
  .drawer-item { display: flex; gap: 20px; margin-bottom: 30px; }
  .drawer-item-img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; background: #fff; }
  .drawer-item-info { flex: 1; }
  .drawer-item-title { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; font-weight: 600; margin: 0 0 5px; }
  .drawer-item-price { font-size: 1.4rem; font-weight: 500; opacity: 0.8; }
  
  .drawer-footer { padding: 40px; background: rgba(26,46,26,0.02); border-top: 1px solid rgba(26,46,26,0.05); }
  .drawer-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-weight: 600; font-size: 1.8rem; }
  .btn-checkout { 
    display: block; width: 100%; padding: 18px; background: #1A2E1A; color: #F8F5F0; 
    text-align: center; text-transform: uppercase; letter-spacing: 0.12em; 
    font-size: 1.2rem; font-weight: 600; border-radius: 4px; text-decoration: none;
    transition: background 0.2s;
  }
  .btn-checkout:hover { background: #2D4D2D; }
  .empty-msg { text-align: center; margin-top: 50px; font-family: 'Cormorant Garamond', serif; font-size: 2rem; opacity: 0.7; }

  /* ── AJAX Search ── */
  .mh-search-wrap {
    position: relative;
  }
  .mh-search-form {
    display: flex;
    align-items: center;
    background: rgba(26,46,26,0.06);
    border: 1px solid rgba(26,46,26,0.15);
    border-radius: 30px;
    padding: 0 14px 0 18px;
    gap: 8px;
    transition: border-color 0.2s, background 0.2s;
  }
  .mh-search-form:focus-within {
    background: #fff;
    border-color: rgba(26,46,26,0.35);
  }
  .mh-search-input {
    border: none;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-size: 1.25rem;
    color: #1A2E1A;
    width: 180px;
    outline: none;
    padding: 9px 0;
  }
  .mh-search-input::placeholder { color: rgba(26,46,26,0.45); }
  .mh-search-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    opacity: 0.55;
    transition: opacity 0.2s;
  }
  .mh-search-btn:hover { opacity: 1; }
  .mh-search-btn svg { width: 16px; height: 16px; stroke: #1A2E1A; fill: none; stroke-width: 2; }

  /* Dropdown */
  .mh-search-results {
    position: absolute;
    top: calc(100% + 10px);
    left: 0;
    width: 320px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    overflow: hidden;
    z-index: 500;
    display: none;
  }
  .mh-search-results.is-open { display: block; }
  .mh-result-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 16px;
    text-decoration: none;
    color: #1A2E1A;
    transition: background 0.15s;
    border-bottom: 1px solid rgba(26,46,26,0.05);
  }
  .mh-result-item:last-child { border-bottom: none; }
  .mh-result-item:hover { background: #F8F5F0; }
  .mh-result-img {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 6px;
    background: #EEE9E1;
    flex-shrink: 0;
  }
  .mh-result-info { flex: 1; min-width: 0; }
  .mh-result-title {
    font-family: 'Inter', sans-serif;
    font-size: 1.25rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    margin-bottom: 3px;
  }
  .mh-result-price {
    font-size: 1.15rem;
    opacity: 0.6;
  }
  .mh-result-empty {
    padding: 20px 16px;
    font-size: 1.25rem;
    opacity: 0.5;
    text-align: center;
    font-family: 'Inter', sans-serif;
  }
  .mh-result-all {
    display: block;
    padding: 12px 16px;
    font-size: 1.2rem;
    font-weight: 600;
    color: #4a7c59;
    text-align: center;
    text-decoration: none;
    background: rgba(74,124,89,0.07);
    transition: background 0.15s;
  }
  .mh-result-all:hover { background: rgba(74,124,89,0.14); }

  .minima-search-overlay {
    position: fixed;
    top: -120%;
    left: 0;
    width: 100%;
    height: 120px;
    background: #FFFFFF;
    z-index: 2000;
    display: flex;
    align-items: center;
    padding: 0 32px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: top 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }
  .minima-search-overlay.is-active { top: 0; }
  .minima-search-overlay__inner { max-width: 1200px; margin: 0 auto; width: 100%; display: flex; align-items: center; gap: 20px; }
  .minima-search-overlay__form { flex: 1; display: flex; align-items: center; position: relative; }
  .minima-search-overlay__input {
    width: 100%;
    border: none;
    border-bottom: 1px solid rgba(26,46,26,0.1);
    padding: 15px 40px 15px 0;
    font-size: 2rem;
    font-family: 'Inter', sans-serif;
    outline: none;
    background: transparent;
  }
  .minima-search-overlay__close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 10px;
    color: #1A2E1A;
    opacity: 0.5;
    transition: 0.2s;
  }
  .minima-search-overlay__icon {
    position: absolute;
    right: 0;
    opacity: 0.5;
    pointer-events: none;
  }
  .minima-search-overlay__icon svg { width: 20px; height: 20px; }

  .minima-menu-drawer {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100%;
    background: #F8F5F0;
    z-index: 1001;
    box-shadow: -5px 0 30px rgba(0,0,0,0.1);
    transition: right 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    display: flex;
    flex-direction: column;
    color: #1A2E1A;
  }
  .minima-menu-drawer.is-active { right: 0; }
  .minima-menu-drawer .drawer-header { padding: 32px; }
  .mobile-nav-list { list-style: none; padding: 40px; margin: 0; }
  .mobile-nav-item { margin-bottom: 24px; }
  .mobile-nav-link {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.2rem;
    font-weight: 500;
    text-decoration: none;
    color: #1A2E1A;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  @media (max-width: 989px) {
    .minima-header__nav,
    .mh-search-wrap { display: none; }
    .minima-header__logo-img { height: 32px; }
    .minima-header__inner { padding: 0 20px; }
    .minima-header__actions { gap: 10px; }
    .minima-header__cart {
      border: none;
      padding: 8px;
    }
    .minima-header__cart span { display: none; }
    .minima-header__cart svg { width: 24px; height: 24px; }
    .mh-action-btn--search { display: flex; }
    .minima-header__menu-toggle { display: block; order: 3; }
    .minima-cart-drawer,
    .minima-menu-drawer { width: 100%; right: -100%; }
    .minima-search-overlay { padding: 0 20px; height: 100px; }
    .minima-search-overlay__input { font-size: 1.6rem; }
  }

  @media (min-width: 990px) {
    .mh-action-btn--search { display: none; }
    .minima-header__menu-toggle { display: none; }
  }
{%- endstyle -%}

<div class="minima-header-wrap">
  <div class="minima-announcement">Envíos GRATIS: pedidos superiores a 35 euros</div>
  <header class="minima-header">
    <div class="minima-header__inner">
      <a href="/" class="minima-header__logo-link">
        <img src="{{ 'minima.png' | asset_url }}" class="minima-header__logo-img" alt="Minima Organics" width="180" height="45">
      </a>
      <div class="minima-header__center">
        <nav role="navigation">
          <ul class="minima-header__nav">
            <li><a href="/collections/all">Tienda</a></li>
            <li><a href="/pages/sobre-nosotras">Sobre nosotras</a></li>
            <li><a href="/blogs/noticias">Blog</a></li>
            <li><a href="/pages/contact">Contacto</a></li>
          </ul>
        </nav>
        <!-- AJAX Search -->
        <div class="mh-search-wrap" id="mh-search-wrap">
          <form class="mh-search-form" action="/search" method="get" role="search" autocomplete="off">
            <input
              type="search"
              name="q"
              id="mh-search-input"
              class="mh-search-input"
              placeholder="Estoy buscando..."
              aria-label="Buscar productos"
              aria-autocomplete="list"
              aria-controls="mh-search-results">
            <input type="hidden" name="type" value="product">
            <button type="submit" class="mh-search-btn" aria-label="Buscar">
              <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </button>
          </form>
          <div id="mh-search-results" class="mh-search-results" role="listbox"></div>
        </div>
      </div>

      <div class="minima-header__actions">
        <button class="mh-action-btn mh-action-btn--search" onclick="toggleSearchOverlay()" aria-label="Abrir búsqueda">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
        <div class="minima-header__cart" onclick="toggleCartDrawer()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          <span>Cesta</span>
          <div id="cart-dot" class="cart-count-bubble" style="display:none;">0</div>
        </div>
        <button class="minima-header__menu-toggle" onclick="toggleMobileMenu()" aria-label="Abrir menú">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </header>
</div>

<!-- Mobile Search Overlay -->
<div id="minima-search-overlay" class="minima-search-overlay">
  <div class="minima-search-overlay__inner">
    <button class="minima-search-overlay__close" onclick="toggleSearchOverlay()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
    <form class="minima-search-overlay__form" action="/search" method="get">
      <input type="search" name="q" id="minima-search-mobile-input" class="minima-search-overlay__input" placeholder="Estoy buscando..." autocomplete="off">
      <span class="minima-search-overlay__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </span>
    </form>
  </div>
</div>

<!-- Mobile Menu Drawer -->
<div id="minima-menu-drawer" class="minima-menu-drawer">
  <div class="drawer-header">
    <h2 class="drawer-title">Menú</h2>
    <div class="drawer-close" onclick="toggleMobileMenu()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </div>
  </div>
  <ul class="mobile-nav-list">
    <li class="mobile-nav-item"><a href="/collections/all" class="mobile-nav-link">Tienda</a></li>
    <li class="mobile-nav-item"><a href="/pages/sobre-nosotras" class="mobile-nav-link">Sobre nosotras</a></li>
    <li class="mobile-nav-item"><a href="/blogs/noticias" class="mobile-nav-link">Blog</a></li>
    <li class="mobile-nav-item"><a href="/pages/contact" class="mobile-nav-link">Contacto</a></li>
  </ul>
</div>

<!-- FAILSAFE MINI CART COMPONENT -->
<div id="minima-overlay" class="minima-cart-overlay" onclick="closeAllDrawers()"></div>
<div id="minima-drawer" class="minima-cart-drawer">
  <div class="drawer-header">
    <h2 class="drawer-title">Tu Cesta</h2>
    <div class="drawer-close" onclick="toggleCartDrawer()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </div>
  </div>
  <div id="drawer-items-list" class="drawer-items">
    <!-- Items will be injected here -->
  </div>
  <div id="drawer-footer-area" class="drawer-footer" style="display:none;">
    <div class="drawer-total">
      <span>Total</span>
      <span id="drawer-total-price">€0,00</span>
    </div>
    <a href="/checkout" class="btn-checkout">Pagar Pedido</a>
  </div>
</div>

<script>
  function closeAllDrawers() {
    ['minima-drawer', 'minima-menu-drawer', 'minima-search-overlay', 'minima-overlay'].forEach(id => {
      const element = document.getElementById(id);
      if (element) { element.classList.remove('is-active'); }
    });
    document.body.style.overflow = '';
  }

  function toggleMobileMenu() {
    const drawer = document.getElementById('minima-menu-drawer');
    const overlay = document.getElementById('minima-overlay');
    if (!drawer || !overlay) return;
    const isActive = drawer.classList.contains('is-active');

    if (!isActive) {
      closeAllDrawers();
      drawer.classList.add('is-active');
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    } else {
      closeAllDrawers();
    }
  }

  function toggleSearchOverlay() {
    const overlay = document.getElementById('minima-search-overlay');
    const input = document.getElementById('minima-search-mobile-input');
    if (!overlay) return;
    const isActive = overlay.classList.contains('is-active');

    if (!isActive) {
      closeAllDrawers();
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
      setTimeout(() => input?.focus(), 400);
    } else {
      overlay.classList.remove('is-active');
      document.body.style.overflow = '';
    }
  }

  /* === AJAX Search === */
  (function() {
    var input   = document.getElementById('mh-search-input');
    var results = document.getElementById('mh-search-results');
    var wrap    = document.getElementById('mh-search-wrap');
    if (!input || !results) return;

    var timer = null;
    var currentQuery = '';

    function close() {
      results.classList.remove('is-open');
      results.innerHTML = '';
    }

    function open(html) {
      results.innerHTML = html;
      results.classList.add('is-open');
    }

    input.addEventListener('input', function() {
      var q = this.value.trim();
      clearTimeout(timer);
      if (q.length < 2) { close(); return; }
      if (q === currentQuery) return;
      currentQuery = q;

      timer = setTimeout(function() {
        fetch('/search/suggest.json?q=' + encodeURIComponent(q) + '&resources[type]=product&resources[limit]=5')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var products = (data.resources && data.resources.results && data.resources.results.products) || [];
            if (products.length === 0) {
              open('<p class="mh-result-empty">Sin resultados para "' + q + '"</p>');
              return;
            }
            var html = '';
            products.forEach(function(p) {
              var img = p.featured_image ? p.featured_image.url : '';
              var price = p.price ? formatMoney(p.price) : '';
              html += '<a class="mh-result-item" href="' + p.url + '" role="option">' +
                (img ? '<img class="mh-result-img" src="' + img + '" alt="' + p.title.replace(/"/g,'') + '" loading="lazy">' : '<div class="mh-result-img"></div>') +
                '<div class="mh-result-info"><span class="mh-result-title">' + p.title + '</span>' +
                (price ? '<span class="mh-result-price">' + price + '</span>' : '') +
                '</div></a>';
            });
            html += '<a class="mh-result-all" href="/search?type=product&q=' + encodeURIComponent(q) + '">Ver todos los resultados →</a>';
            open(html);
          })
          .catch(function() { close(); });
      }, 300);
    });

    document.addEventListener('keydown', function(e) { if(e.key === 'Escape') close(); });
    document.addEventListener('click', function(e) { if (!wrap.contains(e.target)) close(); });
  })();

  function toggleCartDrawer() {
    const drawer = document.getElementById('minima-drawer');
    const overlay = document.getElementById('minima-overlay');
    if (!drawer || !overlay) return;
    const isActive = drawer.classList.contains('is-active');

    if (!isActive) {
      closeAllDrawers();
      updateCartUI();
      drawer.classList.add('is-active');
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    } else {
      closeAllDrawers();
    }
  }

  async function updateCartUI() {
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();

      const list = document.getElementById('drawer-items-list');
      const footer = document.getElementById('drawer-footer-area');
      const dot = document.getElementById('cart-dot');
      const totalDisplay = document.getElementById('drawer-total-price');

      if (cart.item_count > 0) {
        dot.textContent = cart.item_count;
        dot.style.display = 'flex';
        footer.style.display = 'block';
        totalDisplay.textContent = formatMoney(cart.total_price);
        list.innerHTML = cart.items.map(item => `
          <div class="drawer-item">
            <img src="${item.image}" alt="${item.title}" class="drawer-item-img">
            <div class="drawer-item-info">
              <h3 class="drawer-item-title">${item.product_title}</h3>
              <div class="drawer-item-price">${item.quantity} x ${formatMoney(item.final_price)}</div>
            </div>
          </div>
        `).join('');
      } else {
        dot.style.display = 'none';
        list.innerHTML = '<p class="empty-msg">Tu cesta está vacía</p>';
        footer.style.display = 'none';
      }
    } catch (e) {
      console.error('Error fetching cart:', e);
    }
  }

  function formatMoney(cents) {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }

  document.addEventListener('DOMContentLoaded', updateCartUI);
</script>

{% schema %}
{
  "name": "Minima Header",
  "settings": [],
  "presets": [{ "name": "Minima Header" }]
}
{% endschema %}
