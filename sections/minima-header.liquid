{%- style -%}
  .minima-header-wrap { position: relative; z-index: 100; font-family: 'Inter', sans-serif; }
  .minima-announcement { background: #1A2E1A; color: #F8F5F0; text-align: center; padding: 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; }
  .minima-header { background: #F8F5F0; border-bottom: 1px solid rgba(26,46,26,0.1); padding: 16px 0; }
  .minima-header__inner { display: flex; justify-content: space-between; align-items: center; max-width: 1260px; margin: 0 auto; padding: 0 32px; }
  .minima-header__logo-link { display: block; line-height: 0; }
  .minima-header__logo-img { height: 45px; width: auto; display: block; }
  .minima-header__nav { display: flex; gap: 32px; list-style: none; margin: 0; padding: 0; }
  .minima-header__nav a { font-size: 13px; font-weight: 500; text-transform: uppercase; text-decoration: none; color: #1A2E1A; opacity: 0.8; transition: opacity 0.2s; }
  .minima-header__nav a:hover { opacity: 1; border-bottom: 1px solid #1A2E1A; }
  .minima-header__center { display: flex; align-items: center; gap: 24px; }
  /* Mobile Menu Toggle */
  .minima-header__menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; color: #1A2E1A; }
  .minima-header__menu-toggle svg { width: 24px; height: 24px; }

  /* Desktop Header Actions */
  .mh-action-btn { background: none; border: none; cursor: pointer; padding: 8px; color: #1A2E1A; display: flex; align-items: center; justify-content: center; }
  .mh-action-btn svg { width: 22px; height: 22px; stroke-width: 1.5; }

  /* ... existing drawer styles ... */
  .minima-menu-drawer {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100%;
    background: #F8F5F0;
    z-index: 1001;
    box-shadow: -5px 0 30px rgba(0,0,0,0.1);
    transition: right 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    display: flex;
    flex-direction: column;
    color: #1A2E1A;
  }
  .minima-menu-drawer.is-active { right: 0; }

  /* Mobile Nav Styles */
  .mobile-nav-list { list-style: none; padding: 40px; margin: 0; }
  .mobile-nav-item { margin-bottom: 24px; }
  .mobile-nav-link { font-family: 'Cormorant Garamond', serif; font-size: 2.4rem; font-weight: 500; text-decoration: none; color: #1A2E1A; text-transform: uppercase; letter-spacing: 0.05em; }

  /* ── Search Overlay ── */
  .minima-search-overlay {
    position: fixed;
    top: -120%;
    left: 0;
    width: 100%;
    height: 120px;
    background: #FFFFFF;
    z-index: 2000;
    display: flex;
    align-items: center;
    padding: 0 32px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: top 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }
  .minima-search-overlay.is-active { top: 0; }
  .minima-search-overlay__inner { max-width: 1200px; margin: 0 auto; width: 100%; display: flex; align-items: center; gap: 20px; }
  .minima-search-overlay__form { flex: 1; display: flex; align-items: center; position: relative; }
  .minima-search-overlay__input { 
    width: 100%; border: none; border-bottom: 1px solid rgba(26,46,26,0.1); padding: 15px 40px 15px 0; 
    font-size: 2rem; font-family: 'Inter', sans-serif; outline: none; background: transparent;
  }
  .minima-search-overlay__close { background: none; border: none; cursor: pointer; padding: 10px; color: #1A2E1A; opacity: 0.5; transition: 0.2s; }
  .minima-search-overlay__icon { position: absolute; right: 0; opacity: 0.5; pointer-events: none; }
  .minima-search-overlay__icon svg { width: 20px; height: 20px; }

  @media (max-width: 989px) { 
    .minima-header__nav, .mh-search-wrap { display: none; }
    .minima-header__menu-toggle { display: block; order: 3; }
    .minima-header__logo-img { height: 32px; }
    .minima-header__inner { padding: 0 20px; }
    .minima-header__actions { gap: 10px; order: 2; }
    .minima-header__cart { border: none; padding: 8px; }
    .minima-header__cart span { display: none; }
    .minima-header__cart svg { width: 24px; height: 24px; }
    .minima-header__actions .mh-action-btn--search { display: flex; }
    .minima-cart-drawer, .minima-menu-drawer { width: 100%; right: -100%; }
    .minima-search-overlay { padding: 0 20px; height: 100px; }
    .minima-search-overlay__input { font-size: 1.6rem; }
  }

  @media (min-width: 990px) {
    .mh-action-btn--search { display: none; }
  }
{%- endstyle -%}

<div class="minima-header-wrap">
  <div class="minima-announcement">Envíos GRATIS: pedidos superiores a 35 euros</div>
  <header class="minima-header">
    <div class="minima-header__inner">
      <a href="/" class="minima-header__logo-link">
        <img src="{{ 'minima.png' | asset_url }}" class="minima-header__logo-img" alt="Minima Organics" width="180" height="45">
      </a>
      <div class="minima-header__center">
        <nav role="navigation">
          <ul class="minima-header__nav">
            <li><a href="/collections/all">Tienda</a></li>
            <li><a href="/pages/sobre-nosotras">Sobre nosotras</a></li>
            <li><a href="/blogs/noticias">Blog</a></li>
            <li><a href="/pages/contact">Contacto</a></li>
          </ul>
        </nav>
        <!-- AJAX Search -->
        <div class="mh-search-wrap" id="mh-search-wrap">
          <form class="mh-search-form" action="/search" method="get" role="search" autocomplete="off">
            <input
              type="search"
              name="q"
              id="mh-search-input"
              class="mh-search-input"
              placeholder="Estoy buscando..."
              aria-label="Buscar productos"
              aria-autocomplete="list"
              aria-controls="mh-search-results">
            <input type="hidden" name="type" value="product">
            <button type="submit" class="mh-search-btn" aria-label="Buscar">
              <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </button>
          </form>
          <div id="mh-search-results" class="mh-search-results" role="listbox"></div>
        </div>
      </div>

      <div class="minima-header__actions">
        <!-- Search Toggle (Mobile) -->
        <button class="mh-action-btn mh-action-btn--search" onclick="toggleSearchOverlay()" aria-label="Abrir búsqueda">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>

        <!-- Cart -->
        <div class="minima-header__cart" onclick="toggleCartDrawer()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          <span>Cesta</span>
          <div id="cart-dot" class="cart-count-bubble" style="display:none;">0</div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="minima-header__menu-toggle" onclick="toggleMobileMenu()" aria-label="Menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </header>
</div>

<!-- Mobile Search Overlay -->
<div id="minima-search-overlay" class="minima-search-overlay">
  <div class="minima-search-overlay__inner">
    <button class="minima-search-overlay__close" onclick="toggleSearchOverlay()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
    <form class="minima-search-overlay__form" action="/search" method="get">
      <input type="search" name="q" id="minima-search-mobile-input" class="minima-search-overlay__input" placeholder="Estoy buscando..." autocomplete="off">
      <span class="minima-search-overlay__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </span>
    </form>
  </div>
</div>

<!-- Mobile Menu Drawer -->
<div id="minima-menu-drawer" class="minima-menu-drawer">
  <div class="drawer-header">
    <h2 class="drawer-title">Menú</h2>
    <div class="drawer-close" onclick="toggleMobileMenu()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </div>
  </div>
  <ul class="mobile-nav-list">
    <li class="mobile-nav-item"><a href="/collections/all" class="mobile-nav-link">Tienda</a></li>
    <li class="mobile-nav-item"><a href="/pages/sobre-nosotras" class="mobile-nav-link">Sobre nosotras</a></li>
    <li class="mobile-nav-item"><a href="/blogs/noticias" class="mobile-nav-link">Blog</a></li>
    <li class="mobile-nav-item"><a href="/pages/contact" class="mobile-nav-link">Contacto</a></li>
  </ul>
</div>

<!-- FAILSAFE MINI CART COMPONENT -->
<div id="minima-overlay" class="minima-cart-overlay" onclick="closeAllDrawers()"></div>
<div id="minima-drawer" class="minima-cart-drawer">
  <div class="drawer-header">
    <h2 class="drawer-title">Tu Cesta</h2>
    <div class="drawer-close" onclick="toggleCartDrawer()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </div>
  </div>
  <div id="drawer-items-list" class="drawer-items">
    <!-- Items will be injected here -->
  </div>
  <div id="drawer-footer-area" class="drawer-footer" style="display:none;">
    <div class="drawer-total">
      <span>Total</span>
      <span id="drawer-total-price">€0,00</span>
    </div>
    <a href="/checkout" class="btn-checkout">Pagar Pedido</a>
  </div>
</div>

<script>
  /* === Shared Utilities === */
  function formatMoney(cents) {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }

  function closeAllDrawers() {
    document.getElementById('minima-drawer').classList.remove('is-active');
    document.getElementById('minima-menu-drawer').classList.remove('is-active');
    document.getElementById('minima-overlay').classList.remove('is-active');
    document.body.style.overflow = '';
  }

  /* === Mobile Menu === */
  function toggleMobileMenu() {
    const drawer = document.getElementById('minima-menu-drawer');
    const overlay = document.getElementById('minima-overlay');
    const isActive = drawer.classList.contains('is-active');
    
    if(!isActive) {
      closeAllDrawers();
      drawer.classList.add('is-active');
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    } else {
      closeAllDrawers();
    }
  }

  /* === Search Overlay === */
  function toggleSearchOverlay() {
    const overlay = document.getElementById('minima-search-overlay');
    const input = document.getElementById('minima-search-mobile-input');
    const isActive = overlay.classList.contains('is-active');
    
    if(!isActive) {
      overlay.classList.add('is-active');
      setTimeout(() => input.focus(), 400);
      document.body.style.overflow = 'hidden';
    } else {
      overlay.classList.remove('is-active');
      document.body.style.overflow = '';
    }
  }

  /* === AJAX Search (Desktop) === */
  (function() {
    var input = document.getElementById('mh-search-input');
    var results = document.getElementById('mh-search-results');
    var wrap = document.getElementById('mh-search-wrap');
    if (!input || !results) return;

    var timer = null;
    input.addEventListener('input', function() {
      var q = this.value.trim();
      clearTimeout(timer);
      if (q.length < 2) { results.classList.remove('is-open'); return; }

      timer = setTimeout(function() {
        fetch('/search/suggest.json?q=' + encodeURIComponent(q) + '&resources[type]=product&resources[limit]=5')
          .then(r => r.json())
          .then(data => {
            var products = data.resources.results.products || [];
            if (products.length === 0) { results.innerHTML = '<p class="mh-result-empty">No hay resultados</p>'; }
            else {
              let html = products.map(p => `
                <a class="mh-result-item" href="${p.url}">
                  <img class="mh-result-img" src="${p.featured_image.url}" alt="">
                  <div class="mh-result-info">
                    <span class="mh-result-title">${p.title}</span>
                    <span class="mh-result-price">${formatMoney(p.price)}</span>
                  </div>
                </a>
              `).join('');
              html += `<a class="mh-result-all" href="/search?q=${encodeURIComponent(q)}&type=product">Ver todos los resultados →</a>`;
              results.innerHTML = html;
            }
            results.classList.add('is-open');
          });
      }, 300);
    });
    document.addEventListener('click', e => { if (!wrap.contains(e.target)) results.classList.remove('is-open'); });
  })();

  /* === Cart Logic === */
  function toggleCartDrawer() {
    const drawer = document.getElementById('minima-drawer');
    const overlay = document.getElementById('minima-overlay');
    if(!drawer.classList.contains('is-active')) {
      closeAllDrawers();
      updateCartUI();
      drawer.classList.add('is-active');
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    } else {
      closeAllDrawers();
    }
  }

  async function updateCartUI() {
    const response = await fetch('/cart.js');
    const cart = await response.json();
    const dot = document.getElementById('cart-dot');
    const list = document.getElementById('drawer-items-list');
    const footer = document.getElementById('drawer-footer-area');
    const totalDisplay = document.getElementById('drawer-total-price');

    if(cart.item_count > 0) {
      dot.textContent = cart.item_count;
      dot.style.display = 'flex';
      footer.style.display = 'block';
      totalDisplay.textContent = formatMoney(cart.total_price);
      list.innerHTML = cart.items.map(item => `
        <div class="drawer-item">
          <img src="${item.image}" alt="" class="drawer-item-img">
          <div class="drawer-item-info">
            <h3 class="drawer-item-title">${item.product_title}</h3>
            <div class="drawer-item-price">${item.quantity} x ${formatMoney(item.final_price)}</div>
          </div>
        </div>
      `).join('');
    } else {
      dot.style.display = 'none';
      list.innerHTML = '<p class="empty-msg">Tu cesta está vacía</p>';
      footer.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', updateCartUI);
</script>

{% schema %}
{
  "name": "Minima Header",
  "settings": [],
  "presets": [{ "name": "Minima Header" }]
}
{% endschema %}
