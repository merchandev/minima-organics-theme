{%- style -%}
  .mpc-section {
    background: #F8F5F0;
    padding: 80px 0 100px;
  }
  .mpc-header {
    max-width: 1260px;
    margin: 0 auto;
    padding: 0 32px 40px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 16px;
  }
  @media (max-width: 640px) {
    .mpc-header { padding: 0 16px 28px; flex-direction: column; align-items: flex-start; }
  }
  .mpc-header__title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2rem, 3.5vw, 3rem);
    font-weight: 400;
    color: #1A2E1A;
    margin: 0;
    letter-spacing: -0.01em;
    line-height: 1.15;
  }
  .mpc-header__link {
    font-family: 'Inter', sans-serif;
    font-size: 1.2rem;
    font-weight: 500;
    color: #1A2E1A;
    text-decoration: none;
    border-bottom: 1px solid rgba(26,46,26,0.3);
    white-space: nowrap;
    padding-bottom: 2px;
    transition: border-color 0.2s;
  }
  .mpc-header__link:hover { border-color: #1A2E1A; }

  /* Carousel wrapper */
  .mpc-carousel-outer {
    position: relative;
    max-width: 1260px;
    margin: 0 auto;
    padding: 0 32px;
  }
  @media (max-width: 640px) {
    .mpc-carousel-outer { padding: 0 16px; }
  }

  /* Track + mask */
  .mpc-track-mask {
    overflow: hidden;
  }
  .mpc-track {
    display: flex;
    gap: 20px;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }
  /* Each card: 1/4 on desktop, 1/3 on tablet, 1/2 on mobile */
  .mpc-card {
    flex: 0 0 calc(25% - 15px);
    min-width: 0;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  @media (max-width: 1024px) {
    .mpc-card { flex: 0 0 calc(33.333% - 14px); }
  }
  @media (max-width: 640px) {
    .mpc-card { flex: 0 0 100%; scroll-snap-align: start; }
    .mpc-track {
      gap: 0;
      overflow-x: scroll;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .mpc-track::-webkit-scrollbar { display: none; }
    .mpc-track-mask { overflow: visible; }
  }

  /* Card inner */
  .mpc-card__img-wrap {
    position: relative;
    width: 100%;
    padding-top: 100%; /* square */
    overflow: hidden;
    background: #fff;
    border-radius: 8px;
    transition: box-shadow 0.25s;
  }
  .mpc-card:hover .mpc-card__img-wrap {
    box-shadow: 0 6px 24px rgba(0,0,0,0.09);
  }
  .mpc-card__img-wrap img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transition: transform 0.3s ease;
  }
  .mpc-card:hover .mpc-card__img-wrap img {
    transform: scale(1.03);
  }
  .mpc-card__info {
    padding: 14px 4px 0;
    text-align: center;
  }
  .mpc-card__title {
    font-family: 'Inter', sans-serif;
    font-size: 1.35rem;
    font-weight: 400;
    color: #1A2E1A;
    margin: 0 0 6px;
    line-height: 1.4;
  }
  .mpc-card__price {
    font-family: 'Inter', sans-serif;
    font-size: 1.2rem;
    color: #1A2E1A;
    opacity: 0.65;
    margin: 0;
  }

  /* Arrows — white circle, light border, like minimaorganics.com */
  .mpc-arrow {
    position: absolute;
    top: calc(50% - 30px);
    transform: translateY(-50%);
    z-index: 10;
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(26,46,26,0.15);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, border-color 0.2s, transform 0.2s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  .mpc-arrow:hover {
    background: #fff;
    border-color: rgba(26,46,26,0.4);
    transform: translateY(-50%) scale(1.06);
  }
  .mpc-arrow[disabled] {
    opacity: 0.3;
    cursor: default;
    pointer-events: none;
  }
  .mpc-arrow--prev { left: -4px; }
  .mpc-arrow--next { right: -4px; }
  .mpc-arrow svg {
    width: 18px; height: 18px;
    stroke: #1A2E1A;
    fill: none;
    stroke-width: 2;
  }
  @media (max-width: 640px) {
    .mpc-arrow { width: 36px; height: 36px; }
    .mpc-arrow svg { width: 15px; height: 15px; }
    .mpc-arrow--prev { left: 0; }
    .mpc-arrow--next { right: 0; }
  }
{%- endstyle -%}

{%- assign col = section.settings.collection -%}
{%- assign source = collections[col].products -%}
{%- if source == blank -%}
  {%- assign source = collections.all.products -%}
{%- endif -%}

<section class="mpc-section" id="mpc-{{ section.id }}">
  <div class="mpc-header">
    <h2 class="mpc-header__title">{{ section.settings.heading }}</h2>
    <a href="/collections/{{ col | default: 'all' }}" class="mpc-header__link">Ver todos los productos →</a>
  </div>

  <div class="mpc-carousel-outer">
    <button class="mpc-arrow mpc-arrow--prev" id="mpc-prev-{{ section.id }}" aria-label="Anterior" disabled>
      <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    </button>

    <div class="mpc-track-mask">
      <div class="mpc-track" id="mpc-track-{{ section.id }}">
        {%- for product in source limit: section.settings.max_products -%}
          <a class="mpc-card" href="{{ product.url }}" data-mpc-card>
            <div class="mpc-card__img-wrap">
              {%- if product.featured_image -%}
                <img
                  src="{{ product.featured_image | image_url: width: 600 }}"
                  alt="{{ product.featured_image.alt | escape | default: product.title }}"
                  loading="lazy"
                  width="600"
                  height="600">
              {%- else -%}
                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0.15;">
                  {{- 'product-1' | placeholder_svg_tag: 'placeholder-svg' -}}
                </div>
              {%- endif -%}
            </div>
            <div class="mpc-card__info">
              <p class="mpc-card__title">{{ product.title }}</p>
              <p class="mpc-card__price">{{ product.price | money }}</p>
            </div>
          </a>
        {%- endfor -%}
      </div>
    </div>

    <button class="mpc-arrow mpc-arrow--next" id="mpc-next-{{ section.id }}" aria-label="Siguiente">
      <svg viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </button>
  </div>
</section>

<script>
(function() {
  var sectionId = '{{ section.id }}';
  var track   = document.getElementById('mpc-track-' + sectionId);
  var prevBtn = document.getElementById('mpc-prev-' + sectionId);
  var nextBtn = document.getElementById('mpc-next-' + sectionId);
  if (!track) return;

  /* Fisher-Yates shuffle */
  var cards = Array.from(track.querySelectorAll('[data-mpc-card]'));
  for (var i = cards.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    track.appendChild(cards[j]);
    var tmp = cards[i]; cards[i] = cards[j]; cards[j] = tmp;
  }
  /* Re-query in new order */
  cards = Array.from(track.querySelectorAll('[data-mpc-card]'));

  var current = 0;

  function visibleCount() {
    var w = window.innerWidth;
    if (w <= 640)  return 1;
    if (w <= 1024) return 3;
    return 4;
  }

  function totalSteps() {
    return Math.max(0, cards.length - visibleCount());
  }

  function cardWidth() {
    if (!cards[0]) return 0;
    var gap = parseFloat(window.getComputedStyle(track).gap) || 0;
    return cards[0].getBoundingClientRect().width + gap;
  }

  function render() {
    track.style.transform = 'translateX(-' + (current * cardWidth()) + 'px)';
    prevBtn.disabled = current <= 0;
    nextBtn.disabled = current >= totalSteps();
  }

  prevBtn.addEventListener('click', function() {
    if (window.innerWidth <= 640) {
      /* Mobile: use native scroll */
      var mask = track.parentElement;
      var w = track.querySelector('[data-mpc-card]').getBoundingClientRect().width;
      track.scrollBy({ left: -w, behavior: 'smooth' });
    } else {
      current = Math.max(0, current - 1);
      render();
    }
  });
  nextBtn.addEventListener('click', function() {
    if (window.innerWidth <= 640) {
      var w = track.querySelector('[data-mpc-card]').getBoundingClientRect().width;
      track.scrollBy({ left: w, behavior: 'smooth' });
    } else {
      current = Math.min(totalSteps(), current + 1);
      render();
    }
  });

  window.addEventListener('resize', function() {
    current = Math.min(current, totalSteps());
    render();
  });

  render();
})();
</script>

{% schema %}
{
  "name": "Productos destacados",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título",
      "default": "Nuestros productos"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Colección"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Número máximo de productos",
      "min": 4,
      "max": 24,
      "step": 1,
      "default": 12
    }
  ],
  "presets": [
    { "name": "Productos destacados" }
  ]
}
{% endschema %}
